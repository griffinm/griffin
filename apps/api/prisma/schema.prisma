generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(uuid()) @map("id")
  email               String              @unique @map("email")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  password            String              @default("") @map("password")
  firstName           String?             @map("first_name")
  media               Media[]
  notebooks           Notebook[]
  questions           Question[]
  tasks               Task[]
  tags                Tag[]
  audioTranscriptions AudioTranscription[]
  conversations       Conversation[]

  @@map("users")
}

model Tag {
  id         String      @id @default(uuid()) @map("id")
  name       String      @map("name")
  color      String      @default("bg-blue-300") @map("color")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  deletedAt  DateTime?   @map("deleted_at")
  user       User        @relation(fields: [userId], references: [id])
  userId     String      @map("user_id")
  objectTags ObjectTag[]

  @@unique([userId, name])
  @@map("tags")
}

model ObjectTag {
  id         String   @id @default(uuid()) @map("id")
  tagId      String   @map("tag_id")
  objectType String   @map("object_type") // 'note' or 'task'
  objectId   String   @map("object_id")
  createdAt  DateTime @default(now()) @map("created_at")
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@index([objectType, objectId])
  @@index([tagId])
  @@map("object_tags")
}

model Notebook {
  id        String     @id @default(uuid()) @map("id")
  userId    String     @map("user_id")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  title     String?    @map("title")
  deletedAt DateTime?  @map("deleted_at")
  isDefault Boolean    @default(false) @map("is_default")
  parentId  String?    @map("parent_id")
  parent    Notebook?  @relation("NotebookChildren", fields: [parentId], references: [id])
  children  Notebook[] @relation("NotebookChildren")
  user      User       @relation(fields: [userId], references: [id])
  notes     Note[]

  @@map("notebooks")
}

model Note {
  id         String     @id @default(uuid()) @map("id")
  title      String?    @map("title")
  content    String?    @map("content")
  notebookId String     @map("notebook_id")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  deletedAt  DateTime?  @map("deleted_at")
  media      Media[]
  notebook   Notebook   @relation(fields: [notebookId], references: [id])
  questions  Question[]
  tasks      Task[]

  @@map("notes")
}

model Media {
  id        String   @id @default(uuid()) @map("id")
  noteId    String   @map("note_id")
  createdAt DateTime @default(now()) @map("created_at")
  key       String   @map("key")
  mimeType  String   @map("mime_type")
  size      Int      @map("size")
  userId    String   @map("user_id")
  publicUrl String   @map("public_url")
  note      Note     @relation(fields: [noteId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("media")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
}

model Task {
  id            String              @id @default(uuid()) @map("id")
  title         String              @map("title")
  description   String?             @map("description")
  dueDate       DateTime?           @map("due_date")
  status        TaskStatus          @default(TODO) @map("status")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  deletedAt     DateTime?           @map("deleted_at")
  userId        String              @map("user_id")
  noteId        String?             @map("note_id")
  priority      TaskPriority        @default(MEDIUM) @map("priority")
  note          Note?               @relation(fields: [noteId], references: [id])
  user          User                @relation(fields: [userId], references: [id])
  statusHistory TaskStatusHistory[]
  completedAt   DateTime?           @map("completed_at")

  @@map("tasks")
}

model TaskStatusHistory {
  id        String     @id @default(uuid()) @map("id")
  taskId    String     @map("task_id")
  status    TaskStatus @map("status")
  changedAt DateTime   @default(now()) @map("changed_at")
  task      Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_status_history")
}

model Question {
  id        String    @id @default(uuid()) @map("id")
  question  String    @map("question")
  answer    String?   @map("answer")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  userId    String    @map("user_id")
  noteId    String    @map("note_id")
  note      Note      @relation(fields: [noteId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@map("questions")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model AudioTranscription {
  id              String    @id @default(uuid()) @map("id")
  userId          String    @map("user_id")
  transcription   String    @map("transcription")
  language        String?   @map("language")
  duration        Float?    @map("duration") // Duration in seconds
  processingTime  Int       @map("processing_time") // Processing time in milliseconds
  fileName        String    @map("file_name")
  mimeType        String    @map("mime_type")
  fileSize        Int       @map("file_size") // File size in bytes
  model           String    @default("whisper-1") @map("model") // OpenAI model used
  responseFormat  String    @default("json") @map("response_format")
  prompt          String?   @map("prompt") // Optional prompt used for transcription
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  user            User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("audio_transcriptions")
}

enum ConversationItemRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

model Conversation {
  id                String             @id @default(uuid()) @map("id")
  userId            String             @map("user_id")
  title             String?            @map("title")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  deletedAt         DateTime?          @map("deleted_at")
  user              User               @relation(fields: [userId], references: [id])
  conversationItems ConversationItem[]

  @@index([userId])
  @@index([createdAt])
  @@map("conversations")
}

model ConversationItem {
  id             String               @id @default(uuid()) @map("id")
  conversationId String               @map("conversation_id")
  role           ConversationItemRole @map("role")
  content        String               @map("content")
  toolCalls      Json?                @map("tool_calls")
  toolCallId     String?              @map("tool_call_id")
  toolName       String?              @map("tool_name")
  createdAt      DateTime             @default(now()) @map("created_at")
  conversation   Conversation         @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("conversation_items")
}
